{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary mb-1">
                <i class="bi bi-receipt me-2"></i>Transaction Details
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'transactions:transaction_list' %}" class="text-decoration-none">Transactions</a>
                    </li>
                    <li class="breadcrumb-item active">#{{ transaction.id }}</li>
                </ol>
            </nav>
        </div>
        <div class="btn-group">
            <a href="{% url 'transactions:transaction_edit' pk=transaction.pk %}" class="btn btn-warning">
                <i class="bi bi-pencil-square me-2"></i>Edit
            </a>
            <a href="{% url 'transactions:transaction_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Transaction Details -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Basic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold text-muted">Transaction ID:</td>
                                    <td><span class="badge bg-dark fs-6">#{{ transaction.id }}</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Date:</td>
                                    <td>{{ transaction.date }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Location:</td>
                                    <td>
                                        {% if transaction.location %}
                                            <span class="badge bg-primary">{{ transaction.location.name }}</span>
                                        {% else %}
                                            <span class="text-muted">No location specified</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Created:</td>
                                    <td>{{ transaction.created_at|date:"M d, Y H:i" }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Last Updated:</td>
                                    <td>{{ transaction.updated_at|date:"M d, Y H:i" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold text-muted">Created By:</td>
                                    <td>
                                        {% if transaction.user %}
                                            {{ transaction.user.get_full_name|default:transaction.user.username }}
                                        {% else %}
                                            <span class="text-muted">System</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if transaction.customer %}
                                <tr>
                                    <td class="fw-bold text-muted">Customer:</td>
                                    <td>
                                        {% if transaction.customer.id %}
                                        <a href="{% url 'transactions:customer_detail' customer_id=transaction.customer.id %}" 
                                           class="text-decoration-none">
                                            {{ transaction.customer.name }}
                                        </a>
                                        {% else %}
                                            {{ transaction.customer.name }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    <!-- Enhanced Notes Section -->
                    <div class="mt-4">
                        <div class="card {% if transaction.notes %}border-info{% else %}border-secondary{% endif %}">
                            <div class="card-header {% if transaction.notes %}bg-info text-white{% else %}bg-light text-muted{% endif %}">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-chat-text me-2"></i>
                                    Transaction Notes
                                    {% if not transaction.notes %}
                                        <small class="ms-2">(No notes added)</small>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if transaction.notes %}
                                    <div class="notes-content">
                                        {{ transaction.notes|linebreaksbr }}
                                    </div>
                                    <div class="mt-3 text-muted small">
                                        <i class="bi bi-clock me-1"></i>
                                        Notes entered on: {{ transaction.created_at|date:"M d, Y" }}
                                    </div>
                                {% else %}
                                    <div class="text-center text-muted py-3">
                                        <i class="bi bi-chat-square-text display-4 d-block mb-2"></i>
                                        <p class="mb-0">No notes were added for this transaction.</p>
                                        <small>
                                            <a href="{% url 'transactions:transaction_edit' pk=transaction.pk %}" class="text-decoration-none">
                                                Add notes by editing this transaction
                                            </a>
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calculator me-2"></i>Financial Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="financial-summary">
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-success bg-opacity-10 rounded">
                            <span class="fw-bold">Total Sales:</span>
                            <span class="fw-bold text-success fs-5">UGX {{ total_sales|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-danger bg-opacity-10 rounded">
                            <span class="fw-bold">Total Cashout:</span>
                            <span class="fw-bold text-danger fs-5">UGX {{ total_cashout|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-info bg-opacity-10 rounded">
                            <span class="fw-bold">Difference:</span>
                            <span class="fw-bold text-info fs-5">UGX {{ difference|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center p-2 rounded {{ less_excess_class }}">
                            <span class="fw-bold">Final Status:</span>
                            <span class="fw-bold fs-5">{{ less_excess_status }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'transactions:transaction_edit' pk=transaction.pk %}" class="btn btn-warning">
                            <i class="bi bi-pencil me-2"></i>Edit Transaction
                        </a>
                        <a href="{% url 'transactions:transaction_delete' pk=transaction.pk %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-2"></i>Delete Transaction
                        </a>
                        <a href="{% url 'transactions:transaction_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-list-ul me-2"></i>View All Transactions
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Breakdown -->
    <div class="row">
        <!-- Income Breakdown -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-arrow-down-circle me-2"></i>Income Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <tr>
                            <td class="fw-bold">Opening Balance:</td>
                            <td class="text-end">UGX {{ transaction.opening_balance|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Customer Balance:</td>
                            <td class="text-end">UGX {{ transaction.customer_balance|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Paid Sales:</td>
                            <td class="text-end">UGX {{ transaction.paid|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Wholesale:</td>
                            <td class="text-end">UGX {{ transaction.wholesale|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr class="table-success">
                            <td class="fw-bold">Total Income:</td>
                            <td class="text-end fw-bold fs-5">UGX {{ total_sales|floatformat:0|intcomma }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses Breakdown -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-arrow-up-circle me-2"></i>Expenses Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <tr>
                            <td class="fw-bold">Debt Payments:</td>
                            <td class="text-end">UGX {{ transaction.debt|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Cash Withdrawals:</td>
                            <td class="text-end">UGX {{ transaction.cash|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Accounts:</td>
                            <td class="text-end">UGX {{ transaction.accounts|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Expenses:</td>
                            <td class="text-end">UGX {{ transaction.expenses|floatformat:0|intcomma }}</td>
                        </tr>
                        <tr class="table-danger">
                            <td class="fw-bold">Total Expenses:</td>
                            <td class="text-end fw-bold fs-5">UGX {{ total_cashout|floatformat:0|intcomma }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.financial-summary .bg-success { background-color: #d1eddd !important; }
.financial-summary .bg-danger { background-color: #f8d7da !important; }
.financial-summary .bg-info { background-color: #d1ecf1 !important; }

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.card {
    border-radius: 0.5rem;
}

.btn-group .btn {
    border-radius: 0.375rem;
    margin: 0 2px;
}

.notes-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 4px solid #0dcaf0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.d-grid .btn {
    border-radius: 0.375rem;
}
</style>
{% endblock %}