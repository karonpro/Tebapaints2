{% extends 'base.html' %}
{% block content %}
<div class="card p-4 shadow-sm rounded-4">
    <h3 class="mb-4">{% if create %}New{% else %}Edit{% endif %} Transaction</h3>
    <form method="post" novalidate id="transaction-form">
        {% csrf_token %}

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label for="id_date" class="form-label">Date</label>
                {{ form.date }}
            </div>
            <div class="col-md-3">
                <label for="id_location" class="form-label">Location</label>
                {{ form.location }}
            </div>
            <div class="col-md-3">
                <label for="id_opening_balance" class="form-label">Opening Balance</label>
                {{ form.opening_balance }}
            </div>
            <div class="col-md-3">
                <label for="id_customer_balance" class="form-label">Customer Balance</label>
                {{ form.customer_balance }}
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label for="id_paid" class="form-label">Paid</label>
                {{ form.paid }}
            </div>
            <div class="col-md-3">
                <label for="id_wholesale" class="form-label">Wholesale</label>
                {{ form.wholesale }}
            </div>
            <div class="col-md-3">
                <label for="id_debt" class="form-label">Debt</label>
                {{ form.debt }}
            </div>
            <div class="col-md-3">
                <label for="id_cash" class="form-label">Cash</label>
                {{ form.cash }}
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label for="id_accounts" class="form-label">Accounts</label>
                {{ form.accounts }}
            </div>
            <div class="col-md-3">
                <label for="id_expenses" class="form-label">Expenses</label>
                {{ form.expenses }}
            </div>
        </div>

        <div class="mt-3">
            <label for="id_notes" class="form-label">Notes</label>
            {{ form.notes }}
        </div>

        <hr class="my-3">

        <h5>Computed Totals</h5>
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label">Total Sales <small>(Excludes Opening Balance)</small></label>
                <input type="text" id="total_sales" class="form-control bg-light" value="0.00" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Total Cashout <small>(All Outflows)</small></label>
                <input type="text" id="total_cashout" class="form-control bg-light" value="0.00" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Difference <small>(Total Sales - Total Cashout)</small></label>
                <input type="text" id="difference" class="form-control bg-light" value="0.00" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Less / Excess / Balanced</label>
                <input type="text" id="less_excess" class="form-control bg-success text-white" value="Balanced" readonly>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success btn-lg">Save Transaction</button>
            <a href="{% url 'transactions:transaction_list' %}" class="btn btn-secondary btn-lg ms-2">Cancel</a>
        </div>
    </form>
</div>

<script>
function parseValue(id) {
    let val = document.getElementById(id).value;
    return parseFloat(val) || 0;
}

function calculateTotals() {
    const opening = parseValue('id_opening_balance'); 
    const customer = parseValue('id_customer_balance');
    const paid = parseValue('id_paid');
    const wholesale = parseValue('id_wholesale');
    const debt = parseValue('id_debt');
    const cash = parseValue('id_cash');
    const accounts = parseValue('id_accounts');
    const expenses = parseValue('id_expenses');

    // Total Sales excludes opening balance
    const totalSales = customer + paid + wholesale;

    // Total Cashout includes all cash outflows
    const totalCashout = debt + cash + accounts + expenses;

    // Difference = Total Sales - Total Cashout
    const difference = totalSales - totalCashout;

    document.getElementById('total_sales').value = totalSales.toFixed(2);
    document.getElementById('total_cashout').value = totalCashout.toFixed(2);
    document.getElementById('difference').value = difference.toFixed(2);

    // Less / Excess / Balanced = Difference - Opening Balance
    const lessExcessValue = difference - opening;
    const lessExcessField = document.getElementById('less_excess');

    if (lessExcessValue > 0) {
        lessExcessField.value = `Less ${lessExcessValue.toFixed(0)}`;
        lessExcessField.className = 'form-control text-white bg-warning';
    } else if (lessExcessValue < 0) {
        lessExcessField.value = `Excess ${Math.abs(lessExcessValue).toFixed(0)}`;
        lessExcessField.className = 'form-control text-white bg-danger';
    } else {
        lessExcessField.value = 'Balanced';
        lessExcessField.className = 'form-control text-white bg-success';
    }
}

// Attach input event listeners
['id_opening_balance','id_customer_balance','id_paid','id_wholesale','id_debt','id_cash','id_accounts','id_expenses']
.forEach(id => {
    const field = document.getElementById(id);
    if(field) field.addEventListener('input', calculateTotals);
});

// Initial calculation on page load
calculateTotals();
</script>
{% endblock %}