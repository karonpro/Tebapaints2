{% extends 'base.html' %}
{% load humanize %}
{% load custom_filters %}

{% block content %}
<div class="card p-4 shadow-lg border-0 bg-dark text-light">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-info fw-bold mb-0">
      <i class="fas fa-exchange-alt me-2"></i>Transactions
      {% if not request.GET.start_date and not request.GET.end_date %}
        - Last 30 Days
      {% endif %}
    </h2>
    <a class="btn btn-success btn-lg" href="{% url 'transactions:transaction_add' %}">
      <i class="fas fa-plus-circle me-2"></i>New Transaction
    </a>
  </div>

  <!-- Date Range Info -->
  <div class="alert alert-info mb-4">
    <div class="d-flex align-items-center flex-wrap">
      <i class="fas fa-calendar-alt me-2"></i>
      <span class="me-3">
        {% if start_date and end_date %}
          Showing transactions from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
        {% else %}
          Showing <strong>Last 30 Days</strong> of transactions
        {% endif %}
      </span>
      <div class="btn-group ms-auto">
        <a href="?days=7" class="btn btn-sm {% if request.GET.days == '7' %}btn-info{% else %}btn-outline-info{% endif %}">Last 7 Days</a>
        <a href="?days=30" class="btn btn-sm {% if not request.GET.days or request.GET.days == '30' %}btn-info{% else %}btn-outline-info{% endif %}">Last 30 Days</a>
        <a href="?days=90" class="btn btn-sm {% if request.GET.days == '90' %}btn-info{% else %}btn-outline-info{% endif %}">Last 90 Days</a>
        <a href="?" class="btn btn-sm btn-outline-secondary">All Time</a>
      </div>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="card bg-secondary bg-opacity-25 mb-4 border-0">
    <div class="card-body">
      <h5 class="card-title text-light mb-3">
        <i class="fas fa-filter me-2"></i>Filter Transactions
      </h5>
      <form method="get" class="row g-3">
        <!-- Hidden field to preserve days parameter -->
        {% if request.GET.days %}
          <input type="hidden" name="days" value="{{ request.GET.days }}">
        {% endif %}
        
        <div class="col-md-2">
          <label class="form-label text-light small">Start Date</label>
          <input type="date" name="start_date" value="{{ request.GET.start_date|default:'' }}" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
          <label class="form-label text-light small">End Date</label>
          <input type="date" name="end_date" value="{{ request.GET.end_date|default:'' }}" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-light small">Search Notes</label>
          <input type="text" name="q" value="{{ request.GET.q|default:'' }}" placeholder="Search transactions..." class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-light small">Location</label>
          <select name="location" class="form-select form-select-sm">
            <option value="">All Locations</option>
            {% for loc in locations %}
              <option value="{{ loc.id }}" {% if request.GET.location == loc.id|stringformat:'s' %}selected{% endif %}>
                {{ loc.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end gap-2">
          <button class="btn btn-primary btn-sm flex-fill" type="submit">
            <i class="fas fa-filter me-1"></i>Apply
          </button>
          <a href="?days=30" class="btn btn-outline-secondary btn-sm flex-fill" title="Reset to Last 30 Days">
            <i class="fas fa-refresh"></i>
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Totals Summary -->
  {% if totals %}
  <div class="row g-3 mb-4">
    <div class="col-xl-2 col-md-4 col-6">
      <div class="card bg-success text-white p-3 rounded-3 shadow-sm h-100">
        <div class="card-body text-center p-2">
          <i class="fas fa-arrow-down-circle display-6 mb-2"></i>
          <h6 class="card-title mb-1">Total Sales</h6>
          <h4 class="fw-bold mb-0">UGX {{ totals.sales|floatformat:0|intcomma }}</h4>
        </div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
      <div class="card bg-danger text-white p-3 rounded-3 shadow-sm h-100">
        <div class="card-body text-center p-2">
          <i class="fas fa-arrow-up-circle display-6 mb-2"></i>
          <h6 class="card-title mb-1">Total Cashout</h6>
          <h4 class="fw-bold mb-0">UGX {{ totals.cashout|floatformat:0|intcomma }}</h4>
        </div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
      <div class="card bg-info text-white p-3 rounded-3 shadow-sm h-100">
        <div class="card-body text-center p-2">
          <i class="fas fa-balance-scale display-6 mb-2"></i>
          <h6 class="card-title mb-1">Difference</h6>
          <h4 class="fw-bold mb-0 {% if totals.difference >= 0 %}text-success{% else %}text-warning{% endif %}">
            UGX {{ totals.difference|floatformat:0|intcomma }}
          </h4>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 col-6">
      <div class="card bg-warning text-dark p-3 rounded-3 shadow-sm h-100">
        <div class="card-body text-center p-2">
          <i class="fas fa-exclamation-triangle display-6 mb-2"></i>
          <h6 class="card-title mb-1">Total Less</h6>
          <h4 class="fw-bold mb-0">UGX {{ less_value|default:0|floatformat:0|intcomma }}</h4>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 col-6">
      <div class="card bg-success text-white p-3 rounded-3 shadow-sm h-100">
        <div class="card-body text-center p-2">
          <i class="fas fa-check-circle display-6 mb-2"></i>
          <h6 class="card-title mb-1">Total Excess</h6>
          <h4 class="fw-bold mb-0">UGX {{ excess_value|default:0|floatformat:0|intcomma }}</h4>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Transactions Table -->
  <div class="card bg-secondary bg-opacity-25 border-0">
    <div class="card-header bg-dark bg-opacity-50 border-bottom d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0 text-light">
        <i class="fas fa-table me-2"></i>Transaction Records
        <span class="badge bg-primary ms-2">{{ rows|length }} records</span>
      </h5>
      {% if not request.GET.start_date and not request.GET.end_date %}
        <small class="text-muted">Last 30 Days</small>
      {% endif %}
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover table-striped align-middle mb-0">
          <thead class="table-secondary">
            <tr>
              <th class="ps-3">Date</th>
              <th>Location</th>
              <th class="text-end">Total Sales</th>
              <th class="text-end">Total Cashout</th>
              <th class="text-end">Difference</th>
              <th class="text-center">Status</th>
              <th class="text-center pe-3">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in rows %}
            <tr>
              <td class="ps-3">
                <strong>{{ transaction.date }}</strong>
              </td>
              <td>
                <span class="badge bg-primary">{{ transaction.location.name|default:"No Location" }}</span>
              </td>
              <td class="text-end">
                <span class="fw-bold text-success">UGX {{ transaction.total_sales|floatformat:0|intcomma }}</span>
              </td>
              <td class="text-end">
                <span class="fw-bold text-danger">UGX {{ transaction.total_cashout|floatformat:0|intcomma }}</span>
              </td>
              <td class="text-end">
                <span class="fw-bold {% if transaction.difference > 0 %}text-success{% else %}text-danger{% endif %}">
                  UGX {{ transaction.difference|floatformat:0|intcomma }}
                </span>
              </td>
              <td class="text-center">
                {% if transaction.less_excess > 0 %}
                  <span class="badge bg-danger">
                    <i class="fas fa-arrow-down me-1"></i>Less: UGX {{ transaction.less_excess|floatformat:0|intcomma }}
                  </span>
                {% elif transaction.less_excess < 0 %}
                  <span class="badge bg-success">
                    <i class="fas fa-arrow-up me-1"></i>Excess: UGX {{ transaction.less_excess|abs_value|floatformat:0|intcomma }}
                  </span>
                {% else %}
                  <span class="badge bg-secondary">
                    <i class="fas fa-check-circle me-1"></i>Balanced
                  </span>
                {% endif %}
              </td>
              <td class="text-center pe-3">
                <div class="btn-group">
                  <!-- View Button -->
                  <a class="btn btn-info btn-sm text-white" 
                     href="{% url 'transactions:transaction_detail' pk=transaction.pk %}"
                     title="View Full Details">
                      <i class="fas fa-eye me-1"></i>View
                  </a>
                  
                  <!-- Edit Button -->
                  <a class="btn btn-warning btn-sm text-dark" 
                     href="{% url 'transactions:transaction_edit' pk=transaction.pk %}"
                     title="Edit Transaction">
                      <i class="fas fa-edit me-1"></i>Edit
                  </a>
                  
                  <!-- Delete Button -->
                  <a class="btn btn-danger btn-sm text-white" 
                     href="{% url 'transactions:transaction_delete' pk=transaction.pk %}"
                     onclick="return confirm('Are you sure you want to delete transaction #{{ transaction.id }}? This action cannot be undone.');"
                     title="Delete Transaction">
                      <i class="fas fa-trash me-1"></i>Delete
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4">
                <div class="text-muted">
                  <i class="fas fa-inbox display-4 d-block mb-2"></i>
                  <h5>No transactions found</h5>
                  <p class="mb-0">
                    {% if request.GET.start_date or request.GET.end_date %}
                      No transactions found for the selected date range.
                    {% else %}
                      No transactions found for the last 30 days.
                    {% endif %}
                  </p>
                  <a href="{% url 'transactions:transaction_add' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-plus-circle me-1"></i>Create First Transaction
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<style>
.card {
  backdrop-filter: blur(10px);
}

.table-dark {
  --bs-table-bg: rgba(33, 37, 41, 0.95);
  --bs-table-border-color: #495057;
}

.table-hover tbody tr:hover {
  background-color: rgba(255, 255, 255, 0.1) !important;
}

.btn-group .btn {
  border-radius: 0.375rem;
  margin: 0 1px;
}

.badge {
  font-size: 0.75em;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .btn-group {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .btn-group .btn {
    margin: 0;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
  }
}
</style>

<script>
// Auto-set default dates to last 30 days if no dates are selected
document.addEventListener('DOMContentLoaded', function() {
  const startDateInput = document.querySelector('input[name="start_date"]');
  const endDateInput = document.querySelector('input[name="end_date"]');
  
  // If no dates are set and no custom filters are applied, set default to last 30 days
  if (!startDateInput.value && !endDateInput.value && !window.location.search.includes('start_date') && !window.location.search.includes('end_date')) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    startDateInput.value = startDate.toISOString().split('T')[0];
    endDateInput.value = endDate.toISOString().split('T')[0];
  }
});
</script>
{% endblock %}