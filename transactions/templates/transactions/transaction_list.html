{% extends 'base.html' %}
{% load humanize %}
{% load custom_filters %}  {# Loads your abs_value filter #}
{% block content %}

<div class="card p-4 shadow-lg border-0 bg-dark text-light">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-info fw-bold">ðŸ’° Transactions Overview</h3>
    <a class="btn btn-success" href="{% url 'transactions:transaction_add' %}">
      <i class="bi bi-plus-circle"></i> New Transaction
    </a>
  </div>

  <!-- Filter Form -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-2">
      <input type="date" name="start_date" value="{{ request.GET.start_date|default:'' }}" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" name="end_date" value="{{ request.GET.end_date|default:'' }}" class="form-control">
    </div>
    <div class="col-md-3">
      <input type="text" name="q" value="{{ request.GET.q|default:'' }}" placeholder="Search notes..." class="form-control">
    </div>
    <div class="col-md-3">
      <select name="location" class="form-select">
        <option value="">All Locations</option>
        {% for loc in locations %}
          <option value="{{ loc.id }}" {% if selected_location == loc.id|stringformat:'s' %}selected{% endif %}>
            {{ loc.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 text-end">
      <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>
  </form>

  <!-- Totals Summary -->
  {% if totals %}
  <div class="row text-center mb-4">
    <div class="col-md-2 mb-2">
      <div class="card bg-success text-white p-2 rounded shadow-sm">
        <h6>Total Sales</h6>
        <h5>UGX {{ totals.sales|floatformat:0|intcomma }}</h5>
      </div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card bg-danger text-white p-2 rounded shadow-sm">
        <h6>Total Cashout</h6>
        <h5>UGX {{ totals.cashout|floatformat:0|intcomma }}</h5>
      </div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card bg-info text-white p-2 rounded shadow-sm">
        <h6>Total Difference</h6>
        <h5>UGX {{ totals.difference|floatformat:0|intcomma }}</h5>
      </div>
    </div>
    <div class="col-md-3 mb-2">
      <div class="card bg-danger text-white p-2 rounded shadow-sm">
        <h6>Total Less</h6>
        <h5>UGX {{ less_value|floatformat:0|intcomma }}</h5>
      </div>
    </div>
    <div class="col-md-3 mb-2">
      <div class="card bg-success text-white p-2 rounded shadow-sm">
        <h6>Total Excess</h6>
        <h5>UGX {{ excess_value|floatformat:0|intcomma }}</h5>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Transactions Table -->
  <div class="table-responsive">
    <table class="table table-hover table-bordered align-middle text-light">
      <thead class="table-secondary text-dark">
        <tr>
          <th>Date</th>
          <th>Location</th>
          <th>Total Sales</th>
          <th>Total Cashout</th>
          <th>Difference</th>
          <th>Status (Less / Excess)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.date }}</td>
          <td>{{ r.location.name|default:"-" }}</td>
          <td>UGX {{ r.total_sales|floatformat:0|intcomma }}</td>
          <td>UGX {{ r.total_cashout|floatformat:0|intcomma }}</td>
          <td>UGX {{ r.difference|floatformat:0|intcomma }}</td>

          <!-- Colored Less/Excess -->
          <td>
            {% if r.less_excess > 0 %}
              <span class="badge bg-danger">Less: UGX {{ r.less_excess|floatformat:0|intcomma }}</span>
            {% elif r.less_excess < 0 %}
              <span class="badge bg-success">Excess: UGX {{ r.less_excess|abs_value|floatformat:0|intcomma }}</span>
            {% else %}
              <span class="badge bg-secondary">Balanced</span>
            {% endif %}
          </td>

          <!-- Action buttons -->
          <td>
            <div class="btn-group">
              <a class="btn btn-sm btn-outline-info" href="{% url 'transactions:view_transaction' r.id %}">View</a>
              <a class="btn btn-sm btn-outline-warning" href="{% url 'transactions:transaction_edit' r.id %}">Edit</a>
              <a class="btn btn-sm btn-outline-danger" href="{% url 'transactions:transaction_delete' r.id %}" onclick="return confirm('Delete this transaction?')">Delete</a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Chart Section -->
  {% if totals %}
  <div class="card mt-4 bg-secondary bg-opacity-25 p-3 shadow-sm">
    <h5 class="mb-3 text-center">ðŸ“Š Less vs Excess Summary</h5>
    <canvas id="lessExcessChart"></canvas>
  </div>
  {% endif %}

</div>

<!-- ChartJS -->
{% if totals %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('lessExcessChart');
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Less', 'Excess'],
    datasets: [{
      label: 'Amount',
      data: [{{ less_value|default:0 }}, {{ excess_value|default:0 }}],
      backgroundColor: ['#e74c3c', '#27ae60'],
      borderRadius: 6
    }]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true } },
    plugins: { legend: { display: false } }
  }
});
</script>
{% endif %}

{% endblock %}