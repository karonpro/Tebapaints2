<!-- templates/inventory/retail/retail_sale.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Process Retail Sale{% endblock %}
{% block page_title %}Process Retail Sale{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-cash-register me-2"></i>New Sale
                </h3>
            </div>
            <div class="card-body">
                <form method="post" id="retailSaleForm" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.product.id_for_label }}" class="form-label">
                                    <strong>{{ form.product.label }}</strong>
                                </label>
                                {{ form.product }}
                                {% if form.product.errors %}
                                    <div class="text-danger small mt-1">{{ form.product.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.location.id_for_label }}" class="form-label">
                                    <strong>{{ form.location.label }}</strong>
                                </label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <div class="text-danger small mt-1">{{ form.location.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.unit_price.id_for_label }}" class="form-label">
                                    <strong>{{ form.unit_price.label }}</strong>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.unit_price }}
                                </div>
                                {% if form.unit_price.errors %}
                                    <div class="text-danger small mt-1">{{ form.unit_price.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">{{ form.unit_price.help_text }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.current_stock.id_for_label }}" class="form-label">
                                    <strong>{{ form.current_stock.label }}</strong>
                                </label>
                                <div class="input-group">
                                    {{ form.current_stock }}
                                    <span class="input-group-text">units</span>
                                </div>
                                <small class="form-text text-muted">Available stock at selected location</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.amount_given.id_for_label }}" class="form-label">
                                    <strong>{{ form.amount_given.label }}</strong>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.amount_given }}
                                </div>
                                {% if form.amount_given.errors %}
                                    <div class="text-danger small mt-1">{{ form.amount_given.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">{{ form.amount_given.help_text }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <div id="calculationResult" class="alert alert-info" style="display: none;">
                                <strong>Calculation:</strong>
                                <span id="amountDisplay">$0.00</span> รท 
                                <span id="priceDisplay">$0.00</span>/unit = 
                                <span id="quantityDisplay">0.00</span> units
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="reset" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-redo me-1"></i>Reset
                        </button>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-cash-register me-2"></i>Process Sale
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Recent Sales -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Sales
                </h5>
            </div>
            <div class="card-body p-0">
                {% if recent_sales %}
                    <div class="list-group list-group-flush">
                        {% for sale in recent_sales %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ sale.product.name }}</h6>
                                        <p class="mb-1 text-success">
                                            <strong>{{ sale.quantity_given|floatformat:2 }} units</strong>
                                            <br>
                                            <small class="text-muted">for ${{ sale.amount_given|floatformat:2 }}</small>
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ sale.location.name }}
                                            <br>
                                            <i class="fas fa-user me-1"></i>{{ sale.sold_by.get_full_name|default:sale.sold_by.username }}
                                        </small>
                                    </div>
                                    <small class="text-muted text-end">
                                        {{ sale.sale_date|timesince }} ago<br>
                                        <span class="badge bg-light text-dark">{{ sale.sale_date|date:"H:i" }}</span>
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No recent sales</p>
                    </div>
                {% endif %}
            </div>
            <div class="card-footer text-center">
                <a href="{% url 'inventory:retail_sales_list' %}" class="btn btn-outline-primary btn-sm">
                    View All Sales
                </a>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Today's Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ recent_sales|length }}</h4>
                        <small class="text-muted">Sales</small>
                    </div>
                    <div class="col-6">
                        {% with total_revenue=0 %}
                            {% for sale in recent_sales %}
                                {% with total_revenue=total_revenue|add:sale.amount_given %}
                                {% endwith %}
                            {% endfor %}
                            <h4 class="text-success">${{ total_revenue|floatformat:2 }}</h4>
                        {% endwith %}
                        <small class="text-muted">Revenue</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
function updateStock() {
    const productId = $('#id_product').val();
    const locationId = $('#id_location').val();
    
    if (productId && locationId) {
        fetch(`/inventory/api/stock/${productId}/${locationId}/`)
            .then(response => response.json())
            .then(data => {
                $('#id_current_stock').val(data.quantity);
                updateCalculation();
            })
            .catch(error => {
                console.error('Error fetching stock:', error);
                $('#id_current_stock').val(0);
            });
    }
}

function updateCalculation() {
    const amount = parseFloat($('#id_amount_given').val()) || 0;
    const unitPrice = parseFloat($('#id_unit_price').val()) || 0;
    
    if (amount > 0 && unitPrice > 0) {
        const quantity = amount / unitPrice;
        $('#amountDisplay').text('$' + amount.toFixed(2));
        $('#priceDisplay').text('$' + unitPrice.toFixed(2));
        $('#quantityDisplay').text(quantity.toFixed(2));
        $('#calculationResult').show();
    } else {
        $('#calculationResult').hide();
    }
}

$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });
    
    // Add event listeners
    $('#id_product, #id_location').on('change', updateStock);
    $('#id_amount_given, #id_unit_price').on('input', updateCalculation);
    
    // Initial updates
    updateStock();
    updateCalculation();
    
    // Form submission validation
    $('#retailSaleForm').on('submit', function(e) {
        const currentStock = parseFloat($('#id_current_stock').val()) || 0;
        const amount = parseFloat($('#id_amount_given').val()) || 0;
        const unitPrice = parseFloat($('#id_unit_price').val()) || 0;
        
        if (amount > 0 && unitPrice > 0) {
            const requiredQuantity = amount / unitPrice;
            if (requiredQuantity > currentStock) {
                e.preventDefault();
                alert(`Insufficient stock! Required: ${requiredQuantity.toFixed(2)} units, Available: ${currentStock.toFixed(2)} units`);
            }
        }
    });
});
</script>
{% endblock %}