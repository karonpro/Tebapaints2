{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Add Payment for {{ sale.document_number }}</h2>
        <a href="{% url 'inventory:sale_payments' sale.id %}" class="btn btn-outline-secondary">‚Üê Back to Payments</a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Record Payment</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="paymentForm">
                        {% csrf_token %}
                        
                        <!-- Display form errors at the top -->
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Please correct the errors below:</strong>
                            <ul class="mb-0">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Amount (UGX) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">UGX</span>
                                    {{ form.amount }}
                                </div>
                                {% if form.amount.help_text %}
                                    <div class="form-text">{{ form.amount.help_text }}</div>
                                {% endif %}
                                {% if form.amount.errors %}
                                    <div class="text-danger small">{{ form.amount.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payment Method *</label>
                                {{ form.payment_method }}
                                {% if form.payment_method.errors %}
                                    <div class="text-danger small">{{ form.payment_method.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Payment Date *</label>
                                {{ form.payment_date }}
                                {% if form.payment_date.errors %}
                                    <div class="text-danger small">{{ form.payment_date.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reference Number</label>
                                {{ form.reference_number }}
                                {% if form.reference_number.errors %}
                                    <div class="text-danger small">{{ form.reference_number.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="text-danger small">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="alert alert-info">
                            <strong>Note:</strong> Maximum payment amount: <strong>UGX {{ balance_due|floatformat:0|intcomma }}</strong>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle"></i> Record Payment
                            </button>
                            <a href="{% url 'inventory:sale_payments' sale.id %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Sale Summary Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Sale Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Customer:</strong><br>
                        <span class="text-muted">{{ sale.customer.name|default:"Walk-in" }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Document:</strong><br>
                        <code>{{ sale.document_number }}</code>
                    </div>
                    <div class="mb-3">
                        <strong>Total Amount:</strong><br>
                        <span class="h5 text-success">UGX {{ sale.total_amount|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Paid Amount:</strong><br>
                        <span class="h6 text-primary">UGX {{ sale.paid_amount|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Balance Due:</strong><br>
                        <span class="h5 text-danger">UGX {{ balance_due|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Status:</strong><br>
                        <span class="badge {% if sale.payment_status == 'fully_paid' %}bg-success{% elif sale.payment_status == 'partially_paid' %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ sale.payment_status|title }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Payment Guidelines -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">Payment Guidelines</h6>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>Enter payment amount in UGX</li>
                        <li>Select appropriate payment method</li>
                        <li>Payment date defaults to current date/time</li>
                        <li>Reference number is optional but recommended</li>
                        <li>Payment cannot exceed the balance due</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentForm = document.getElementById('paymentForm');
    const amountInput = document.getElementById('id_amount');
    const paymentDateInput = document.getElementById('id_payment_date');
    const balanceDue = parseFloat('{{ balance_due }}');

    // Set current datetime as default for payment date if empty
    if (paymentDateInput && !paymentDateInput.value) {
        const now = new Date();
        // Format: YYYY-MM-DDTHH:MM (local time)
        const localDateTime = now.toISOString().slice(0, 16);
        paymentDateInput.value = localDateTime;
    }

    // Validate amount doesn't exceed balance due
    function validateAmount() {
        const amount = parseFloat(amountInput.value) || 0;
        if (amount > balanceDue) {
            amountInput.setCustomValidity(`Payment amount cannot exceed UGX ${balanceDue.toLocaleString()}`);
        } else {
            amountInput.setCustomValidity('');
        }
    }

    // Add UGX formatting to amount input
    amountInput.addEventListener('input', function() {
        validateAmount();
    });

    // Form submission validation
    paymentForm.addEventListener('submit', function(e) {
        validateAmount();
        
        if (!paymentForm.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        paymentForm.classList.add('was-validated');
    });

    // Real-time amount validation
    amountInput.addEventListener('blur', function() {
        validateAmount();
    });

    // Initialize validation
    validateAmount();

    // Add input masking for better UX
    amountInput.addEventListener('focus', function() {
        if (this.value === '0.00') {
            this.value = '';
        }
    });

    amountInput.addEventListener('blur', function() {
        if (!this.value) {
            this.value = '0.00';
        }
    });
});

// Add some CSS for better form styling
const style = document.createElement('style');
style.textContent = `
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    .was-validated .form-control:invalid {
        border-color: #dc3545;
    }
    .was-validated .form-control:valid {
        border-color: #198754;
    }
`;
document.head.appendChild(style);
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}
.card-header {
    font-weight: 600;
}
.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}
.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}