{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h2 class="card-title mb-1">
                                <i class="fas fa-star me-2"></i>Product Performance Report
                            </h2>
                            <p class="card-text mb-0">Product profitability, sales performance, and inventory analysis</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button class="btn btn-light btn-lg dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="printReport()"><i class="fas fa-print me-2"></i>Print Full Report</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="printSummary()"><i class="fas fa-print me-2"></i>Print Summary Only</a></li>
                                    <li><a class="dropdown-item" href="{% url 'inventory:export_report_csv' 'product_performance' %}"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                </ul>
                                <a href="{% url 'inventory:reports_dashboard' %}" class="btn btn-outline-light btn-lg ms-2">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Info Bar -->
    <div class="row mb-4 d-print-none">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted"><strong>Category:</strong> 
                                {% if category_id %}
                                    {% for category in categories %}
                                        {% if category.id == category_id %}{{ category.name }}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    All Categories
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted"><strong>Period:</strong> 
                                {% if date_from %}{{ date_from }}{% else %}Start{% endif %} 
                                to {% if date_to %}{{ date_to }}{% else %}End{% endif %}
                            </small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted"><strong>Min Sales:</strong> {{ min_sales }}+ units</small>
                        </div>
                        <div class="col-md-3 text-end">
                            <small class="text-muted"><strong>Generated:</strong> <span class="generated-timestamp">{% now "M d, Y H:i" %}</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters (Hidden when printing) -->
    <div class="row mb-4 d-print-none filters-section">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Report Filters
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <!-- ... filter form fields ... -->
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Executive Summary (Always visible, even when printing) -->
    <div class="row mb-4 printable-section">
        <div class="col-12">
            <div class="card border-dark">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-pie me-2"></i>Executive Summary
                    </h6>
                    <button class="btn btn-sm btn-outline-light d-print-none" onclick="printSection(this)">
                        <i class="fas fa-print me-1"></i>Print Summary
                    </button>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 border-end">
                            <h4 class="text-primary">{{ product_performance|length|intcomma }}</h4>
                            <small class="text-muted">Products Analyzed</small>
                        </div>
                        <div class="col-md-3 border-end">
                            <h4 class="text-success">UGX {{ total_revenue|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">Total Revenue</small>
                        </div>
                        <div class="col-md-3 border-end">
                            <h4 class="text-info">UGX {{ total_profit|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">Total Profit</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning">{{ avg_margin|floatformat:1 }}%</h4>
                            <small class="text-muted">Average Margin</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Best & Worst Performers -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-success h-100 printable-section">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Top 5 Best Performers
                    </h6>
                    <button class="btn btn-sm btn-outline-light d-print-none" onclick="printSection(this)">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- ... best performers content ... -->
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-danger h-100 printable-section">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Top 5 Worst Performers
                    </h6>
                    <button class="btn btn-sm btn-outline-light d-print-none" onclick="printSection(this)">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- ... worst performers content ... -->
                </div>
            </div>
        </div>
    </div>

    <!-- Product Performance Table -->
    <div class="row">
        <div class="col-12">
            <div class="card printable-section">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-table me-2"></i>Product Performance Details
                    </h6>
                    <div>
                        <span class="badge bg-primary">{{ product_performance|length }} products</span>
                        <button class="btn btn-sm btn-outline-primary ms-2 d-print-none" onclick="printSection(this)">
                            <i class="fas fa-print me-1"></i>Print Table
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if product_performance %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <!-- ... table content ... -->
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No Product Data Available</h5>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    /* Hide non-essential elements */
    .d-print-none, .btn, .dropdown, .navbar, .breadcrumb, .footer,
    .filters-section, .section-print-btn {
        display: none !important;
    }
    
    /* Layout adjustments */
    .container-fluid {
        padding: 0 !important;
        max-width: 100% !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        margin-bottom: 15px !important;
        page-break-inside: avoid;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
    }
    
    /* Table styling for print */
    .table {
        border: 1px solid #000 !important;
        font-size: 11px !important;
    }
    
    .table th {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
    }
    
    .table td, .table th {
        border: 1px solid #ddd !important;
        padding: 4px !important;
    }
    
    /* Ensure black text for printing */
    .text-primary, .text-success, .text-warning, .text-danger,
    .text-info, .text-secondary {
        color: #000 !important;
    }
    
    .bg-primary, .bg-success, .bg-warning, .bg-danger,
    .bg-info, .bg-secondary, .bg-dark {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
    
    .badge {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border: 1px solid #000 !important;
    }
    
    /* Progress bars for print */
    .progress {
        border: 1px solid #000 !important;
        background-color: #fff !important;
    }
    
    .progress-bar {
        background-color: #666 !important;
    }
    
    /* Page breaks and headers */
    .printable-section {
        page-break-inside: avoid;
    }
    
    @page {
        margin: 1cm;
        @top-center {
            content: "Product Performance Report";
            font-size: 12px;
            color: #666;
        }
        @bottom-center {
            content: "Page " counter(page) " of " counter(pages);
            font-size: 10px;
            color: #666;
        }
    }
    
    /* Report title on first page */
    .report-title {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
    }
}

/* Screen styles */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.printable-section {
    position: relative;
}

.section-print-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.executive-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
</style>

<script>
function printReport() {
    window.print();
}

function printSummary() {
    const summarySections = document.querySelectorAll('.printable-section');
    const originalContent = document.body.innerHTML;
    
    let summaryHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Product Performance Summary</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px;
                    color: #000;
                }
                .card { 
                    border: 1px solid #000; 
                    margin-bottom: 15px; 
                    page-break-inside: avoid;
                }
                .card-header { 
                    background-color: #f8f9fa; 
                    padding: 10px; 
                    border-bottom: 2px solid #000;
                    font-weight: bold;
                }
                .executive-summary { 
                    background-color: #f8f9fa !important;
                    border: 2px solid #000 !important;
                }
                .table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    font-size: 11px;
                }
                .table th, .table td { 
                    border: 1px solid #ddd; 
                    padding: 4px; 
                    text-align: left;
                }
                .table th { 
                    background-color: #f8f9fa; 
                }
                @media print {
                    .no-print { display: none; }
                    @page { margin: 1cm; }
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="margin-bottom: 20px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Print Summary
                </button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    Close
                </button>
            </div>
            <div class="report-title">
                <h2>Product Performance Report - Summary</h2>
                <p>Generated on: <span class="generated-timestamp">${new Date().toLocaleString()}</span></p>
            </div>
    `;
    
    summarySections.forEach(section => {
        if (!section.querySelector('.card-body table')) { // Exclude detailed table
            summaryHTML += section.outerHTML;
        }
    });
    
    summaryHTML += '</body></html>';
    
    document.body.innerHTML = summaryHTML;
    window.print();
    document.body.innerHTML = originalContent;
    window.location.reload();
}

function printSection(button) {
    const section = button.closest('.printable-section');
    const originalContent = document.body.innerHTML;
    const sectionContent = section.outerHTML;
    
    document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Product Performance Section</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px;
                    color: #000;
                }
                .card { 
                    border: 1px solid #000; 
                    margin-bottom: 15px; 
                }
                .card-header { 
                    background-color: #f8f9fa; 
                    padding: 10px; 
                    border-bottom: 2px solid #000;
                    font-weight: bold;
                }
                .table { 
                    width: 100%; 
                    border-collapse: collapse; 
                }
                .table th, .table td { 
                    border: 1px solid #ddd; 
                    padding: 6px; 
                    text-align: left;
                }
                .table th { 
                    background-color: #f8f9fa; 
                }
                @media print {
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="margin-bottom: 20px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Print This Section
                </button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    Close
                </button>
            </div>
            ${sectionContent}
        </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    window.location.reload();
}

// Initialize print functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add print buttons to all printable sections
    const printableSections = document.querySelectorAll('.printable-section');
    printableSections.forEach(section => {
        const header = section.querySelector('.card-header');
        if (header && !header.querySelector('.section-print-btn')) {
            const printBtn = document.createElement('button');
            printBtn.className = 'btn btn-sm btn-outline-primary section-print-btn d-print-none';
            printBtn.innerHTML = '<i class="fas fa-print me-1"></i>';
            printBtn.title = 'Print this section';
            printBtn.onclick = function() {
                printSection(this);
            };
            header.appendChild(printBtn);
        }
    });
    
    // Auto-submit form when filters change
    document.getElementById('sort_by')?.addEventListener('change', function() {
        this.form.submit();
    });
    
    document.getElementById('category')?.addEventListener('change', function() {
        this.form.submit();
    });
});

// Update timestamp before printing
window.addEventListener('beforeprint', function() {
    const timestampElements = document.querySelectorAll('.generated-timestamp');
    const now = new Date();
    timestampElements.forEach(el => {
        el.textContent = now.toLocaleString();
    });
});
</script>
{% endblock %}