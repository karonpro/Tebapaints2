{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h2 class="card-title mb-1">
                                <i class="fas fa-chart-line me-2"></i>Sales Summary Report
                            </h2>
                            <p class="card-text mb-0">Comprehensive sales performance and revenue analysis</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button class="btn btn-light btn-lg dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="printReport()"><i class="fas fa-print me-2"></i>Print Report</a></li>
                                    <li><a class="dropdown-item" href="{% url 'inventory:export_report_csv' 'sales_summary' %}"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                </ul>
                                <a href="{% url 'inventory:reports_dashboard' %}" class="btn btn-outline-light btn-lg ms-2">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Info Bar -->
    <div class="row mb-4 d-print-none">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted"><strong>Period:</strong> 
                                {% if date_from %}{{ date_from }}{% else %}Start{% endif %} 
                                to {% if date_to %}{{ date_to }}{% else %}End{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted"><strong>Grouped By:</strong> {{ group_by|title }}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted"><strong>Generated:</strong> {% now "M d, Y H:i" %}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters (Hidden when printing) -->
    <div class="row mb-4 d-print-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Report Filters
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <!-- ... filter form fields ... -->
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-primary border-4 bg-white h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Revenue</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">UGX {{ total_revenue|floatformat:0|intcomma }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ... other summary cards ... -->
    </div>

    <!-- Grouped Data Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card printable-section">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-table me-2"></i>Sales Data Grouped by {{ group_by|title }}
                    </h6>
                    <div>
                        <span class="badge bg-primary">{{ grouped_data|length }} entries</span>
                        <button class="btn btn-sm btn-outline-primary ms-2 d-print-none" onclick="printSection(this)">
                            <i class="fas fa-print me-1"></i>Print This Section
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if grouped_data %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <!-- ... table content ... -->
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No Data Available</h5>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Sections -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card printable-section h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-trophy me-2"></i>Top 10 Products by Revenue
                    </h6>
                    <button class="btn btn-sm btn-outline-primary d-print-none" onclick="printSection(this)">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- ... top products content ... -->
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card printable-section h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-line me-2"></i>Monthly Sales Trend
                    </h6>
                    <button class="btn btn-sm btn-outline-primary d-print-none" onclick="printSection(this)">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- ... trend content ... -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    /* Hide elements when printing */
    .d-print-none, .btn, .dropdown, .navbar, .breadcrumb, .footer,
    .card-header .btn, .filters-section {
        display: none !important;
    }
    
    /* Layout adjustments for printing */
    .container-fluid {
        padding: 0 !important;
        max-width: 100% !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        margin-bottom: 15px !important;
        page-break-inside: avoid;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
    }
    
    .table {
        border: 1px solid #000 !important;
    }
    
    .table th {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
    }
    
    .table td, .table th {
        border: 1px solid #ddd !important;
        padding: 6px !important;
    }
    
    /* Ensure text is black for printing */
    .text-primary, .text-success, .text-warning, .text-danger,
    .text-info, .text-secondary {
        color: #000 !important;
    }
    
    .bg-primary, .bg-success, .bg-warning, .bg-danger,
    .bg-info, .bg-secondary {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
    
    .badge {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border: 1px solid #000 !important;
    }
    
    /* Ensure good contrast */
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05) !important;
    }
    
    /* Page breaks */
    .printable-section {
        page-break-inside: avoid;
    }
    
    /* Header for each printed page */
    @page {
        margin: 1cm;
        @top-center {
            content: "Sales Summary Report - {{ date_from }} to {{ date_to }}";
            font-size: 12px;
            color: #666;
        }
        @bottom-center {
            content: "Page " counter(page) " of " counter(pages);
            font-size: 10px;
            color: #666;
        }
    }
    
    /* Report header on first page */
    .report-header {
        border-bottom: 2px solid #000;
        margin-bottom: 20px;
        padding-bottom: 10px;
    }
}

/* Screen styles */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    border: none;
}

.printable-section {
    position: relative;
}

.section-print-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}
</style>

<script>
function printReport() {
    window.print();
}

function printSection(button) {
    const section = button.closest('.printable-section');
    const originalContent = document.body.innerHTML;
    const sectionContent = section.outerHTML;
    
    document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Sales Report Section</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px;
                    color: #000;
                }
                .card { 
                    border: 1px solid #000; 
                    margin-bottom: 15px; 
                }
                .card-header { 
                    background-color: #f8f9fa; 
                    padding: 10px; 
                    border-bottom: 2px solid #000;
                    font-weight: bold;
                }
                .table { 
                    width: 100%; 
                    border-collapse: collapse; 
                }
                .table th, .table td { 
                    border: 1px solid #ddd; 
                    padding: 6px; 
                    text-align: left;
                }
                .table th { 
                    background-color: #f8f9fa; 
                }
                @media print {
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="margin-bottom: 20px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Print This Section
                </button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    Close
                </button>
            </div>
            ${sectionContent}
        </body>
        </html>
    `;
    
    window.print();
    
    // Restore original content
    document.body.innerHTML = originalContent;
    
    // Re-initialize any JavaScript that was lost
    window.location.reload();
}

// Add print buttons to all printable sections
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form when group_by changes
    document.getElementById('group_by')?.addEventListener('change', function() {
        this.form.submit();
    });
    
    // Add print buttons to all printable sections if they don't have one
    const printableSections = document.querySelectorAll('.printable-section');
    printableSections.forEach(section => {
        const header = section.querySelector('.card-header');
        if (header && !header.querySelector('.section-print-btn')) {
            const printBtn = document.createElement('button');
            printBtn.className = 'btn btn-sm btn-outline-primary section-print-btn d-print-none';
            printBtn.innerHTML = '<i class="fas fa-print me-1"></i>';
            printBtn.title = 'Print this section';
            printBtn.onclick = function() {
                printSection(this);
            };
            header.appendChild(printBtn);
        }
    });
});

// Add beforeprint event to update dynamic content
window.addEventListener('beforeprint', function() {
    // Update the generated timestamp
    const timestampElements = document.querySelectorAll('.generated-timestamp');
    const now = new Date();
    timestampElements.forEach(el => {
        el.textContent = now.toLocaleString();
    });
});
</script>
{% endblock %}