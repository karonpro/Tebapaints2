{% extends "base.html" %}
{% load static %}
{% load inventory_filters %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">
                <i class="fas fa-plus-circle"></i> Create New Sale Order
            </h4>
        </div>
        
        <div class="card-body">
            <form method="post" id="saleOrderForm">
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Order Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="customer" class="form-label">Customer</label>
                                        <select class="form-select" id="customer" name="customer">
                                            <option value="">Walk-in Customer</option>
                                            {% for customer in customers %}
                                            <option value="{{ customer.id }}" 
                                                    {% if form_data.customer == customer.id|stringformat:"i" %}selected{% endif %}>
                                                {{ customer.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="location" class="form-label">Location *</label>
                                        <select class="form-select" id="location" name="location" required>
                                            <option value="">Select Location</option>
                                            {% for location in locations %}
                                            <option value="{{ location.id }}" 
                                                    {% if form_data.location == location.id|stringformat:"i" %}selected{% endif %}>
                                                {{ location.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="sale_date" class="form-label">Sale Date</label>
                                        <input type="datetime-local" class="form-control" id="sale_date" name="sale_date"
                                               value="{{ form_data.sale_date|default:default_date }}">
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="2">{{ form_data.notes }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Add Products</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2 mb-3">
                                    <div class="col-md-7">
                                        <select class="form-select" id="product_select">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" 
                                                    data-name="{{ product.name }}"
                                                    data-sku="{{ product.sku }}"
                                                    data-cost="{{ product.cost_price }}"
                                                    data-selling="{{ product.selling_price }}"
                                                    data-stock="{{ product.stock }}">
                                                {{ product.name }} - Stock: {{ product.stock }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" id="product_quantity" placeholder="Qty" min="1" value="1">
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-primary w-100" id="add_product">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle"></i> 
                                        Products show current stock levels. Make sure you have sufficient stock before confirming the order.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Order Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="order_items_table">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Quantity</th>
                                                <th>Stock Available</th>
                                                <th>Unit Price</th>
                                                <th>Total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="order_items_body">
                                            <!-- Order items will be added here -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-primary">
                                                <td colspan="4" class="text-end"><strong>Grand Total:</strong></td>
                                                <td><strong id="grand_total">$0.00</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-exclamation-triangle"></i> Stock Check</h6>
                                    <div id="stock_warnings">
                                        <!-- Stock warnings will appear here -->
                                    </div>
                                </div>
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-chart-bar"></i> Order Summary</h6>
                                    <p class="mb-1">Total Items: <strong id="total_items">0</strong></p>
                                    <p class="mb-1">Total Quantity: <strong id="total_quantity">0</strong></p>
                                    <p class="mb-0">Total Amount: <strong id="summary_total">$0.00</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden field for items data -->
                <input type="hidden" name="items_data" id="items_data" value="[]">
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Create Sale Order (Draft)
                    </button>
                    <a href="{% url 'inventory:sale_order_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productsData = {{ products_json|safe }};
        let orderItems = [];
        
        // Add product to order
        document.getElementById('add_product').addEventListener('click', function() {
            const productSelect = document.getElementById('product_select');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const quantity = parseInt(document.getElementById('product_quantity').value) || 1;
            
            if (!selectedOption.value) {
                alert('Please select a product');
                return;
            }
            
            if (quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            const productId = selectedOption.value;
            const productName = selectedOption.getAttribute('data-name');
            const unitPrice = parseFloat(selectedOption.getAttribute('data-selling')) || 0;
            const stockAvailable = parseInt(selectedOption.getAttribute('data-stock')) || 0;
            const total = quantity * unitPrice;
            
            // Check if product already exists in order
            const existingIndex = orderItems.findIndex(item => item.product_id == productId);
            if (existingIndex > -1) {
                orderItems[existingIndex].quantity += quantity;
                orderItems[existingIndex].total = orderItems[existingIndex].quantity * unitPrice;
            } else {
                orderItems.push({
                    product_id: productId,
                    product_name: productName,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total: total,
                    stock_available: stockAvailable
                });
            }
            
            updateOrderDisplay();
            productSelect.selectedIndex = 0;
            document.getElementById('product_quantity').value = 1;
        });
        
        // Remove product from order
        function removeProduct(index) {
            orderItems.splice(index, 1);
            updateOrderDisplay();
        }
        
        // Update quantity
        function updateQuantity(index, newQuantity) {
            if (newQuantity > 0) {
                orderItems[index].quantity = parseInt(newQuantity);
                orderItems[index].total = orderItems[index].quantity * orderItems[index].unit_price;
                updateOrderDisplay();
            }
        }
        
        // Update unit price
        function updateUnitPrice(index, newPrice) {
            if (newPrice >= 0) {
                orderItems[index].unit_price = parseFloat(newPrice);
                orderItems[index].total = orderItems[index].quantity * orderItems[index].unit_price;
                updateOrderDisplay();
            }
        }
        
        // Update order display and check stock
        function updateOrderDisplay() {
            const tbody = document.getElementById('order_items_body');
            const grandTotalElem = document.getElementById('grand_total');
            const totalItemsElem = document.getElementById('total_items');
            const totalQuantityElem = document.getElementById('total_quantity');
            const summaryTotalElem = document.getElementById('summary_total');
            const itemsDataField = document.getElementById('items_data');
            const stockWarningsElem = document.getElementById('stock_warnings');
            
            tbody.innerHTML = '';
            let grandTotal = 0;
            let totalQuantity = 0;
            let stockIssues = [];
            
            orderItems.forEach((item, index) => {
                grandTotal += item.total;
                totalQuantity += item.quantity;
                
                // Check stock availability
                if (item.quantity > item.stock_available) {
                    stockIssues.push({
                        product: item.product_name,
                        requested: item.quantity,
                        available: item.stock_available
                    });
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.product_name}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${item.quantity}" min="1" 
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>
                        <span class="badge ${item.quantity > item.stock_available ? 'bg-danger' : 'bg-success'}">
                            ${item.stock_available}
                        </span>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${item.unit_price.toFixed(2)}" step="0.01" min="0" 
                               onchange="updateUnitPrice(${index}, this.value)">
                    </td>
                    <td>$${item.total.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" 
                                onclick="removeProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            grandTotalElem.textContent = `$${grandTotal.toFixed(2)}`;
            totalItemsElem.textContent = orderItems.length;
            totalQuantityElem.textContent = totalQuantity;
            summaryTotalElem.textContent = `$${grandTotal.toFixed(2)}`;
            
            // Update stock warnings
            stockWarningsElem.innerHTML = '';
            if (stockIssues.length > 0) {
                stockIssues.forEach(issue => {
                    const warning = document.createElement('div');
                    warning.className = 'mb-1';
                    warning.innerHTML = `<small>${issue.product}: Requested ${issue.requested}, Available ${issue.available}</small>`;
                    stockWarningsElem.appendChild(warning);
                });
            } else {
                stockWarningsElem.innerHTML = '<small class="text-success">All products have sufficient stock</small>';
            }
            
            // Update hidden field
            itemsDataField.value = JSON.stringify(orderItems.map(item => ({
                product_id: item.product_id,
                quantity: item.quantity,
                unit_price: item.unit_price
            })));
        }
        
        // Form validation
        document.getElementById('saleOrderForm').addEventListener('submit', function(e) {
            if (orderItems.length === 0) {
                e.preventDefault();
                alert('Please add at least one product to the order');
                return false;
            }
            
            const location = document.getElementById('location').value;
            
            if (!location) {
                e.preventDefault();
                alert('Please select a location');
                return false;
            }
            
            // Check for stock issues
            const hasStockIssues = orderItems.some(item => item.quantity > item.stock_available);
            if (hasStockIssues) {
                if (!confirm('Some products have insufficient stock. Do you want to continue creating the order as draft?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
        
        // Make functions global for inline event handlers
        window.removeProduct = removeProduct;
        window.updateQuantity = updateQuantity;
        window.updateUnitPrice = updateUnitPrice;
    });
</script>
{% endblock %}