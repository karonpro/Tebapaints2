{% extends "base.html" %}
{% load static %}
{% load inventory_filters %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4 class="card-title mb-0">
                <i class="fas fa-plus-circle"></i> Create New Purchase Order
            </h4>
        </div>
        
        <div class="card-body">
            <form method="post" id="purchaseOrderForm">
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Order Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="supplier_name" class="form-label">Supplier Name *</label>
                                        <input type="text" class="form-control" id="supplier_name" name="supplier_name" 
                                               value="{{ form_data.supplier_name }}" required>
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="location" class="form-label">Location *</label>
                                        <select class="form-select" id="location" name="location" required>
                                            <option value="">Select Location</option>
                                            {% for location in locations %}
                                            <option value="{{ location.id }}" 
                                                    {% if form_data.location == location.id|stringformat:"i" %}selected{% endif %}>
                                                {{ location.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="order_date" class="form-label">Order Date</label>
                                        <input type="datetime-local" class="form-control" id="order_date" name="order_date"
                                               value="{{ form_data.order_date|default:default_date }}">
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="expected_date" class="form-label">Expected Date</label>
                                        <input type="date" class="form-control" id="expected_date" name="expected_date"
                                               value="{{ form_data.expected_date }}">
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="2">{{ form_data.notes }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Add Products</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2 mb-3">
                                    <div class="col-md-8">
                                        <select class="form-select" id="product_select">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" 
                                                    data-name="{{ product.name }}"
                                                    data-sku="{{ product.sku }}"
                                                    data-cost="{{ product.cost_price }}"
                                                    data-selling="{{ product.selling_price }}">
                                                {{ product.name }} - {{ product.sku }} (Stock: {{ product.total_stock }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" id="product_quantity" placeholder="Qty" min="1" value="1">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success w-100" id="add_product">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="selected_products">
                                    <h6>Selected Products:</h6>
                                    <div id="products_list" class="mb-3" style="min-height: 100px;">
                                        <!-- Products will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Order Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="order_items_table">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Quantity</th>
                                                <th>Unit Price</th>
                                                <th>Total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="order_items_body">
                                            <!-- Order items will be added here -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-primary">
                                                <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                                                <td><strong id="grand_total">$0.00</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Order Summary</h6>
                                    <p class="mb-1">Total Items: <strong id="total_items">0</strong></p>
                                    <p class="mb-1">Total Quantity: <strong id="total_quantity">0</strong></p>
                                    <p class="mb-0">Total Amount: <strong id="summary_total">$0.00</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden field for items data -->
                <input type="hidden" name="items_data" id="items_data" value="[]">
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i> Create Purchase Order
                    </button>
                    <a href="{% url 'inventory:purchase_order_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productsData = {{ products_json|safe }};
        let orderItems = [];
        
        // Add product to order
        document.getElementById('add_product').addEventListener('click', function() {
            const productSelect = document.getElementById('product_select');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const quantity = parseInt(document.getElementById('product_quantity').value) || 1;
            
            if (!selectedOption.value) {
                alert('Please select a product');
                return;
            }
            
            if (quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            const productId = selectedOption.value;
            const productName = selectedOption.getAttribute('data-name');
            const unitPrice = parseFloat(selectedOption.getAttribute('data-cost')) || 0;
            const total = quantity * unitPrice;
            
            // Check if product already exists in order
            const existingIndex = orderItems.findIndex(item => item.product_id == productId);
            if (existingIndex > -1) {
                orderItems[existingIndex].quantity += quantity;
                orderItems[existingIndex].total = orderItems[existingIndex].quantity * unitPrice;
            } else {
                orderItems.push({
                    product_id: productId,
                    product_name: productName,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total: total
                });
            }
            
            updateOrderDisplay();
            productSelect.selectedIndex = 0;
            document.getElementById('product_quantity').value = 1;
        });
        
        // Remove product from order
        function removeProduct(index) {
            orderItems.splice(index, 1);
            updateOrderDisplay();
        }
        
        // Update quantity
        function updateQuantity(index, newQuantity) {
            if (newQuantity > 0) {
                orderItems[index].quantity = parseInt(newQuantity);
                orderItems[index].total = orderItems[index].quantity * orderItems[index].unit_price;
                updateOrderDisplay();
            }
        }
        
        // Update unit price
        function updateUnitPrice(index, newPrice) {
            if (newPrice >= 0) {
                orderItems[index].unit_price = parseFloat(newPrice);
                orderItems[index].total = orderItems[index].quantity * orderItems[index].unit_price;
                updateOrderDisplay();
            }
        }
        
        // Update order display
        function updateOrderDisplay() {
            const tbody = document.getElementById('order_items_body');
            const grandTotalElem = document.getElementById('grand_total');
            const totalItemsElem = document.getElementById('total_items');
            const totalQuantityElem = document.getElementById('total_quantity');
            const summaryTotalElem = document.getElementById('summary_total');
            const itemsDataField = document.getElementById('items_data');
            
            tbody.innerHTML = '';
            let grandTotal = 0;
            let totalQuantity = 0;
            
            orderItems.forEach((item, index) => {
                grandTotal += item.total;
                totalQuantity += item.quantity;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.product_name}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${item.quantity}" min="1" 
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${item.unit_price.toFixed(2)}" step="0.01" min="0" 
                               onchange="updateUnitPrice(${index}, this.value)">
                    </td>
                    <td>$${item.total.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" 
                                onclick="removeProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            grandTotalElem.textContent = `$${grandTotal.toFixed(2)}`;
            totalItemsElem.textContent = orderItems.length;
            totalQuantityElem.textContent = totalQuantity;
            summaryTotalElem.textContent = `$${grandTotal.toFixed(2)}`;
            
            // Update hidden field
            itemsDataField.value = JSON.stringify(orderItems.map(item => ({
                product_id: item.product_id,
                quantity: item.quantity,
                unit_price: item.unit_price
            })));
        }
        
        // Form validation
        document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
            if (orderItems.length === 0) {
                e.preventDefault();
                alert('Please add at least one product to the order');
                return false;
            }
            
            const supplierName = document.getElementById('supplier_name').value.trim();
            const location = document.getElementById('location').value;
            
            if (!supplierName) {
                e.preventDefault();
                alert('Please enter supplier name');
                return false;
            }
            
            if (!location) {
                e.preventDefault();
                alert('Please select a location');
                return false;
            }
        });
        
        // Make functions global for inline event handlers
        window.removeProduct = removeProduct;
        window.updateQuantity = updateQuantity;
        window.updateUnitPrice = updateUnitPrice;
    });
</script>
{% endblock %}