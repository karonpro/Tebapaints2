{% extends "base.html" %}
{% load static %}

{% block title %}Products - Inventory Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Products</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Products</li>
                </ol>
            </nav>
        </div>
        <div class="btn-group">
            <a href="{% url 'inventory:import_products' %}" class="btn btn-success">
                <i class="fas fa-file-import"></i> Import CSV
            </a>
            <a href="{% url 'inventory:export_products' %}" class="btn btn-outline-secondary">
                <i class="fas fa-file-export"></i> Export
            </a>
            <a href="{% url 'inventory:product_add' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Product
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Products</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ product_data|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                In Stock</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="inStockCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Low Stock</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lowStockCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Out of Stock</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="outOfStockCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-filter"></i> Filters & Search
            </h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#filterCollapse" aria-expanded="true" aria-controls="filterCollapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" value="{{ search_query }}"
                                   placeholder="Name, SKU, category...">
                            <button class="btn btn-outline-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"i" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Sort By</label>
                        <select class="form-select" name="sort">
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                            <option value="-name" {% if sort_by == '-name' %}selected{% endif %}>Name (Z-A)</option>
                            <option value="sku" {% if sort_by == 'sku' %}selected{% endif %}>SKU</option>
                            <option value="category__name" {% if sort_by == 'category__name' %}selected{% endif %}>Category</option>
                            <option value="selling_price" {% if sort_by == 'selling_price' %}selected{% endif %}>Price (Low-High)</option>
                            <option value="-selling_price" {% if sort_by == '-selling_price' %}selected{% endif %}>Price (High-Low)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="btn-group w-100">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-redo"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Batch Actions Card -->
    <div class="card mb-4" id="batchActionsCard" style="display: none;">
        <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-tasks"></i> Batch Actions
            </h5>
            <span class="badge bg-light text-dark" id="selectedCount">0</span>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selectedProductsText">0 products selected</span>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-danger" id="batchDeleteBtn" data-bs-toggle="modal" data-bs-target="#batchDeleteModal">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="clearSelectionBtn">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i> Product List
                {% if search_query or category_filter %}
                <small class="text-muted">(Filtered results)</small>
                {% endif %}
            </h5>
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i> Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" id="selectAllBtn">
                        <i class="fas fa-check-square"></i> Select All
                    </a></li>
                    <li><a class="dropdown-item" href="#" id="selectNoneBtn">
                        <i class="fas fa-square"></i> Select None
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'inventory:stock_report' %}">
                        <i class="fas fa-chart-bar"></i> Stock Report
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'inventory:export_products' %}">
                        <i class="fas fa-download"></i> Export All
                    </a></li>
                </ul>
            </div>
        </div>
        <div class="card-body p-0">
            {% if product_data %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="productsTable">
                    <thead class="table-light">
                        <tr>
                            <th width="40" class="ps-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th class="text-end">Cost</th>
                            <th class="text-end">Price</th>
                            <th>Location Quantities</th>
                            <th class="text-center">Total Stock</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in product_data %}
                        <tr class="product-row" data-product-id="{{ item.product.id }}">
                            <td class="ps-3">
                                <div class="form-check">
                                    <input class="form-check-input product-checkbox" type="checkbox" 
                                           value="{{ item.product.id }}" 
                                           data-product-name="{{ item.product.name }}"
                                           data-product-sku="{{ item.product.sku }}">
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-light rounded-2 d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-box text-muted"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <a href="{% url 'inventory:product_detail' item.product.id %}" 
                                           class="text-decoration-none fw-bold text-dark">
                                            {{ item.product.name }}
                                        </a>
                                        {% if item.product.reorder_level and item.total_stock <= item.product.reorder_level %}
                                        <div class="small text-warning">
                                            <i class="fas fa-exclamation-circle"></i> Reorder at {{ item.product.reorder_level }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <code class="small">{{ item.product.sku|default:"-" }}</code>
                            </td>
                            <td>
                                {% if item.product.category %}
                                <span class="badge bg-light text-dark">{{ item.product.category.name }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <span class="fw-bold">UGX {{ item.product.cost_price|floatformat:0 }}</span>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-success">UGX {{ item.product.selling_price|floatformat:0 }}</span>
                            </td>
                            <td>
                                <div class="location-quantities">
                                    {% if item.stocks %}
                                        {% for stock in item.stocks %}
                                            {% if stock.quantity > 0 %}
                                            <div class="location-stock-item d-flex justify-content-between align-items-center mb-1">
                                                <span class="location-name small text-muted">{{ stock.location.name }}</span>
                                                <span class="quantity-badge badge {% if stock.quantity <= item.product.reorder_level %}bg-warning{% else %}bg-light text-dark{% endif %}">
                                                    {{ stock.quantity }}
                                                </span>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% if item.total_stock == 0 %}
                                        <span class="text-muted small">No stock available</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">No stock records</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge {% if item.total_stock == 0 %}bg-danger{% elif item.total_stock <= item.product.reorder_level %}bg-warning{% else %}bg-success{% endif %} fs-6">
                                    {{ item.total_stock }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if item.total_stock == 0 %}
                                <span class="badge bg-danger">Out of Stock</span>
                                {% elif item.total_stock <= item.product.reorder_level %}
                                <span class="badge bg-warning">Low Stock</span>
                                {% else %}
                                <span class="badge bg-success">In Stock</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'inventory:product_edit' item.product.id %}" 
                                       class="btn btn-outline-primary" title="Edit" data-bs-toggle="tooltip">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'inventory:product_detail' item.product.id %}" 
                                       class="btn btn-outline-info" title="View Details" data-bs-toggle="tooltip">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'inventory:product_delete' item.product.id %}" 
                                       class="btn btn-outline-danger" 
                                       title="Delete"
                                       onclick="return confirm('Are you sure you want to delete {{ item.product.name|escapejs }}?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-box-open fa-4x text-muted"></i>
                </div>
                <h5 class="text-muted">No products found</h5>
                <p class="text-muted mb-4">
                    {% if search_query or category_filter %}
                    Try adjusting your search criteria
                    {% else %}
                    Get started by adding your first product
                    {% endif %}
                </p>
                {% if not search_query and not category_filter %}
                <a href="{% url 'inventory:product_add' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add First Product
                </a>
                {% else %}
                <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-redo"></i> Clear Filters
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="text-muted small">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
        </div>
        <nav aria-label="Product pagination">
            <ul class="pagination mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Previous</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Last</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Batch Delete Modal -->
<div class="modal fade" id="batchDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Batch Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading mb-2">⚠️ Critical Action</h6>
                    <p class="mb-0">You are about to delete <strong id="deleteCount">0</strong> product(s). This will permanently remove all product data and associated stock records.</p>
                </div>
                
                <div class="selected-products-section">
                    <h6 class="mb-3">Selected Products:</h6>
                    <div id="selectedProductsList" class="selected-products-container">
                        <!-- Selected products will be listed here -->
                    </div>
                </div>
                
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="confirmDelete">
                    <label class="form-check-label text-danger fw-bold" for="confirmDelete">
                        I understand this action cannot be undone and I have verified the selected products
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmBatchDelete" disabled>
                    <i class="fas fa-trash"></i> Delete Selected Products
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Delete Form -->
<form method="POST" action="{% url 'inventory:product_batch_delete' %}" id="batchDeleteForm">
    {% csrf_token %}
    <input type="hidden" name="product_ids" id="productIdsInput">
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // DOM Elements
    const selectAllCheckbox = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const batchActionsCard = document.getElementById('batchActionsCard');
    const selectedCountSpan = document.getElementById('selectedCount');
    const selectedProductsText = document.getElementById('selectedProductsText');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const confirmBatchDeleteBtn = document.getElementById('confirmBatchDelete');
    const confirmDeleteCheckbox = document.getElementById('confirmDelete');
    const deleteCountSpan = document.getElementById('deleteCount');
    const selectedProductsList = document.getElementById('selectedProductsList');
    const batchDeleteForm = document.getElementById('batchDeleteForm');
    const productIdsInput = document.getElementById('productIdsInput');

    // Calculate stock statistics
    function calculateStockStats() {
        let inStock = 0, lowStock = 0, outOfStock = 0;
        
        productCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const statusBadge = row.querySelector('td:nth-child(9) .badge');
            
            if (statusBadge.classList.contains('bg-success')) {
                inStock++;
            } else if (statusBadge.classList.contains('bg-warning')) {
                lowStock++;
            } else if (statusBadge.classList.contains('bg-danger')) {
                outOfStock++;
            }
        });
        
        document.getElementById('inStockCount').textContent = inStock;
        document.getElementById('lowStockCount').textContent = lowStock;
        document.getElementById('outOfStockCount').textContent = outOfStock;
    }

    // Update selected count and UI
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.product-checkbox:checked').length;
        selectedCountSpan.textContent = selectedCount;
        selectedProductsText.textContent = `${selectedCount} product${selectedCount !== 1 ? 's' : ''} selected`;
        
        // Show/hide batch actions card
        batchActionsCard.style.display = selectedCount > 0 ? 'block' : 'none';
        
        // Update select all checkbox state
        selectAllCheckbox.checked = selectedCount === productCheckboxes.length;
        selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < productCheckboxes.length;
        
        // Update row selection styling
        document.querySelectorAll('.product-row').forEach(row => {
            const checkbox = row.querySelector('.product-checkbox');
            if (checkbox.checked) {
                row.classList.add('table-active');
            } else {
                row.classList.remove('table-active');
            }
        });
    }

    // Select All functionality
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateSelectedCount();
    });

    // Individual checkbox functionality
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // Clear selection
    clearSelectionBtn.addEventListener('click', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        updateSelectedCount();
    });

    // Select All from dropdown
    selectAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
        updateSelectedCount();
    });

    // Select None from dropdown
    selectNoneBtn.addEventListener('click', function(e) {
        e.preventDefault();
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        updateSelectedCount();
    });

    // Batch delete modal setup
    batchDeleteBtn.addEventListener('click', function() {
        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked'));
        const selectedIds = selectedProducts.map(checkbox => checkbox.value);
        const selectedNames = selectedProducts.map(checkbox => checkbox.dataset.productName);
        const selectedSkus = selectedProducts.map(checkbox => checkbox.dataset.productSku);
        
        deleteCountSpan.textContent = selectedIds.length;
        
        // Populate selected products list
        selectedProductsList.innerHTML = '';
        selectedNames.forEach((name, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'selected-product-item d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded';
            listItem.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-box text-muted me-3"></i>
                    <div>
                        <div class="fw-bold">${name}</div>
                        <small class="text-muted">SKU: ${selectedSkus[index] || 'N/A'}</small>
                    </div>
                </div>
                <span class="badge bg-secondary">#${selectedIds[index]}</span>
            `;
            selectedProductsList.appendChild(listItem);
        });
        
        // Reset confirmation
        confirmDeleteCheckbox.checked = false;
        confirmBatchDeleteBtn.disabled = true;
    });

    // Enable/disable delete button based on confirmation
    confirmDeleteCheckbox.addEventListener('change', function() {
        confirmBatchDeleteBtn.disabled = !this.checked;
    });

    // Confirm batch delete
    confirmBatchDeleteBtn.addEventListener('click', function() {
        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked'));
        const selectedIds = selectedProducts.map(checkbox => checkbox.value);
        
        if (selectedIds.length === 0) {
            alert('No products selected for deletion.');
            return;
        }
        
        // Set the product IDs in the form and submit
        productIdsInput.value = selectedIds.join(',');
        batchDeleteForm.submit();
        
        // Show loading state
        confirmBatchDeleteBtn.disabled = true;
        confirmBatchDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    });

    // Row click selection (excluding action buttons)
    document.querySelectorAll('.product-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't trigger if clicking on links, buttons, or checkboxes
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || 
                e.target.type === 'checkbox' || e.target.closest('a') || e.target.closest('button')) {
                return;
            }
            
            const checkbox = this.querySelector('.product-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    });

    // Initialize
    updateSelectedCount();
    calculateStockStats();
});

// Enhanced CSS for better UX
const enhancedStyles = `
    .product-row {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .product-row:hover {
        background-color: #f8f9fa !important;
    }
    .product-row.table-active {
        background-color: #e7f1ff !important;
    }
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .form-check-input:indeterminate {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .selected-products-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    .selected-product-item {
        border-left: 4px solid #dc3545;
    }
    .card.border-left-primary { border-left: 4px solid #4e73df !important; }
    .card.border-left-success { border-left: 4px solid #1cc88a !important; }
    .card.border-left-warning { border-left: 4px solid #f6c23e !important; }
    .card.border-left-danger { border-left: 4px solid #e74a3b !important; }
    
    /* Location Quantities Styles */
    .location-quantities {
        max-height: 120px;
        overflow-y: auto;
        padding-right: 5px;
    }
    .location-quantities::-webkit-scrollbar {
        width: 4px;
    }
    .location-quantities::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    .location-quantities::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 2px;
    }
    .location-quantities::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    .location-stock-item {
        padding: 2px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .location-stock-item:last-child {
        border-bottom: none;
    }
    .location-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .quantity-badge {
        font-size: 0.7rem;
        min-width: 30px;
        text-align: center;
    }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = enhancedStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %}